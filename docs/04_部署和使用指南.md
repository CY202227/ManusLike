# 数字员工部署和使用指南

## 📋 目录

1. [系统要求](#系统要求)
2. [环境准备](#环境准备)
3. [安装部署](#安装部署)
4. [配置说明](#配置说明)
5. [启动指南](#启动指南)
6. [使用示例](#使用示例)
7. [常见问题](#常见问题)
8. [监控运维](#监控运维)

## 🖥️ 系统要求

### 硬件要求

**最低配置**:
- CPU: 2核心
- 内存: 4GB RAM
- 存储: 10GB 可用空间
- 网络: 稳定的互联网连接

**推荐配置**:
- CPU: 4核心或以上
- 内存: 8GB RAM或以上
- 存储: 20GB 可用空间
- 网络: 高速互联网连接

### 软件要求

**操作系统**:
- Linux (Ubuntu 18.04+, CentOS 7+)
- macOS 10.14+
- Windows 10+

**运行环境**:
- Python 3.8+
- pip 21.0+
- Git 2.0+

## 🔧 环境准备

### 1. Python环境

#### 安装Python 3.8+

**Ubuntu/Debian**:
```bash
sudo apt update
sudo apt install python3.8 python3.8-pip python3.8-venv
```

**CentOS/RHEL**:
```bash
sudo yum install python38 python38-pip
```

**macOS**:
```bash
brew install python@3.8
```

**Windows**:
下载并安装Python 3.8+从官方网站: https://www.python.org/downloads/

#### 验证Python版本
```bash
python3 --version
# 输出: Python 3.8.x 或更高版本
```

### 2. Git安装

**Ubuntu/Debian**:
```bash
sudo apt install git
```

**CentOS/RHEL**:
```bash
sudo yum install git
```

**macOS**:
```bash
brew install git
```

**Windows**:
下载Git for Windows: https://git-scm.com/download/win

### 3. 其他依赖

**系统依赖**:
```bash
# Ubuntu/Debian
sudo apt install build-essential libffi-dev libssl-dev

# CentOS/RHEL
sudo yum groupinstall "Development Tools"
sudo yum install openssl-devel libffi-devel
```

## 📦 安装部署

### 1. 获取源代码

```bash
# 克隆项目仓库
git clone https://github.com/your-repo/digital-employee.git
cd digital-employee

# 或者下载ZIP包并解压
wget https://github.com/your-repo/digital-employee/archive/main.zip
unzip main.zip
cd digital-employee-main
```

### 2. 创建虚拟环境

```bash
# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
# Linux/macOS:
source venv/bin/activate

# Windows:
venv\Scripts\activate
```

### 3. 安装依赖

```bash
# 升级pip
pip install --upgrade pip

# 安装项目依赖
pip install -r requirements.txt

# 验证安装
pip list
```

### 4. 目录结构验证

安装完成后，确认项目目录结构：

```
digital-employee/
├── core/                    # 核心业务逻辑
├── tools/                   # 工具管理
├── communication/           # 通信模块
├── interfaces/             # 用户接口
├── data/                   # 数据存储
├── tests/                  # 测试文件
├── docs/                   # 文档
├── main.py                 # 主启动脚本
├── run.py                  # 简化启动脚本
├── requirements.txt        # 依赖文件
└── README.md              # 项目说明
```

## ⚙️ 配置说明

### 1. 大语言模型配置

#### OpenAI API配置

创建配置文件 `config/llm_config.py`:

```python
# LLM配置
LLM_CONFIG = {
    "api_key": "your-openai-api-key",
    "base_url": "https://api.openai.com/v1",  # 或者自定义API地址
    "model_name": "gpt-4",  # 或者 "Qwen-72B"
    "temperature": 0.1,
    "max_tokens": 4000
}
```

#### 本地模型配置

如果使用本地部署的模型：

```python
LLM_CONFIG = {
    "api_key": "sk-local-key",
    "base_url": "http://localhost:8000/v1",
    "model_name": "Qwen-72B",
    "temperature": 0.1,
    "max_tokens": 4000
}
```

### 2. MCP客户端配置

编辑 `communication/mcp_config.json`:

```json
{
  "mcp_servers": {
    "marix": {
      "command": "python",
      "args": ["path/to/mcp/server.py"],
      "env": {
        "PYTHONPATH": "path/to/mcp"
      }
    }
  },
  "tools": {
    "file_generation_tool": {
      "server": "marix",
      "enabled": true
    },
    "web_search_tool": {
      "server": "marix", 
      "enabled": true
    },
    "image_generation_tool": {
      "server": "marix",
      "enabled": true
    }
  }
}
```

### 3. 文件存储配置

创建 `config/storage_config.py`:

```python
# 文件存储配置
STORAGE_CONFIG = {
    "base_path": "./data",
    "task_files_path": "./data/task_files",
    "execution_results_path": "./data/execution_results",
    "max_file_size": 100 * 1024 * 1024,  # 100MB
    "allowed_extensions": [".py", ".txt", ".md", ".html", ".css", ".js", ".json", ".xml"],
    "cleanup_interval": 7 * 24 * 3600,  # 7天清理一次
}
```

### 4. Web界面配置

创建 `config/web_config.py`:

```python
# Web界面配置
WEB_CONFIG = {
    "host": "0.0.0.0",
    "port": 8080,
    "debug": False,
    "cors_origins": ["http://localhost:3000", "http://127.0.0.1:3000"],
    "websocket_timeout": 300,
    "max_connections": 100
}
```

### 5. 日志配置

创建 `config/logging_config.py`:

```python
import logging
from logging.handlers import RotatingFileHandler

# 日志配置
LOGGING_CONFIG = {
    "version": 1,
    "disable_existing_loggers": False,
    "formatters": {
        "default": {
            "format": "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
        },
        "detailed": {
            "format": "%(asctime)s - %(name)s - %(levelname)s - %(filename)s:%(lineno)d - %(message)s"
        }
    },
    "handlers": {
        "console": {
            "class": "logging.StreamHandler",
            "formatter": "default",
            "level": "INFO"
        },
        "file": {
            "class": "logging.handlers.RotatingFileHandler",
            "filename": "logs/app.log",
            "maxBytes": 10485760,  # 10MB
            "backupCount": 5,
            "formatter": "detailed",
            "level": "DEBUG"
        }
    },
    "loggers": {
        "": {
            "handlers": ["console", "file"],
            "level": "INFO",
            "propagate": False
        }
    }
}
```

## 🚀 启动指南

### 1. 快速启动

#### 使用主启动脚本

```bash
# 进入项目目录
cd digital-employee

# 激活虚拟环境
source venv/bin/activate  # Linux/macOS
# 或
venv\Scripts\activate     # Windows

# 启动系统
python main.py
```

系统将显示启动菜单：

```
╔══════════════════════════════════════════════════════════════╗
║                    🤖 数字员工系统启动器                        ║
╠══════════════════════════════════════════════════════════════╣
║  请选择启动模式：                                              ║
║                                                              ║
║  1. 终端聊天模式 - 命令行交互界面                               ║
║  2. Web界面模式 - 浏览器界面                                   ║
║  3. 系统测试模式 - 运行集成测试                                 ║
║  4. 完整系统模式 - 启动所有服务                                 ║
║                                                              ║
║  输入数字选择模式，或输入 'q' 退出                              ║
╚══════════════════════════════════════════════════════════════╝
```

#### 使用简化启动脚本

```bash
# 使用run.py启动
python run.py
```

### 2. 终端聊天模式

选择模式1或直接运行：

```bash
python interfaces/terminal_chat.py
```

系统将显示欢迎界面：

```
╔══════════════════════════════════════════════════════════════╗
║                    🤖 数字员工终端测试系统                      ║
╠══════════════════════════════════════════════════════════════╣
║  这是一个完整的后端功能测试界面                                  ║
║  支持任务规划、工具调用、文件管理等全部功能                        ║
║                                                              ║
║  输入 'help' 查看可用命令                                      ║
║  输入 'quit' 或 'exit' 退出程序                               ║
╚══════════════════════════════════════════════════════════════╝
```

### 3. Web界面模式

选择模式2或直接运行：

```bash
python interfaces/web/frontend/main.py
```

系统启动后，在浏览器中访问：`http://localhost:8080`

### 4. 系统测试模式

选择模式3或直接运行：

```bash
python tests/test_integration.py
```

### 5. Docker部署

#### 创建Dockerfile

```dockerfile
FROM python:3.8-slim

WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    build-essential \
    libffi-dev \
    libssl-dev \
    && rm -rf /var/lib/apt/lists/*

# 复制项目文件
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

# 创建必要目录
RUN mkdir -p data/task_files data/execution_results logs

# 暴露端口
EXPOSE 8080

# 启动命令
CMD ["python", "main.py"]
```

#### 构建镜像

```bash
docker build -t digital-employee:latest .
```

#### 运行容器

```bash
docker run -d \
  --name digital-employee \
  -p 8080:8080 \
  -v $(pwd)/data:/app/data \
  -v $(pwd)/logs:/app/logs \
  digital-employee:latest
```

### 6. Docker Compose部署

创建 `docker-compose.yml`:

```yaml
version: '3.8'

services:
  digital-employee:
    build: .
    ports:
      - "8080:8080"
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./config:/app/config
    environment:
      - PYTHONPATH=/app
    restart: unless-stopped
    
  redis:
    image: redis:alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped

volumes:
  redis_data:
```

启动服务：

```bash
docker-compose up -d
```

## 📝 使用示例

### 1. 终端使用示例

#### 基本对话

```bash
👤 您: 你好
🤖 数字员工: 您好！我是您的AI助手，有什么可以帮您的吗？

👤 您: 生成一个Python的贪吃蛇游戏
🤖 数字员工: 好的，我来为您生成一个Python贪吃蛇游戏。

🔍 分析任务明确度...
📊 任务明确度评分: 8/10
⚙️ 生成执行计划...
```

#### 文件操作

```bash
👤 您: files
📁 文件管理命令:
- files list: 列出所有任务文件
- files download <task_id>: 下载任务文件
- files clean: 清理过期文件

👤 您: files list
📋 任务文件列表:
任务ID: task_123456
└── snake_game.py (5.2KB)
└── README.md (1.1KB)
```

#### 系统状态

```bash
👤 您: status
╔══════════════════════════════════════════════════════════════╗
║                        📊 系统状态                            ║
╠══════════════════════════════════════════════════════════════╣
║ 会话ID: session_1234567890                                   ║
║ 可用工具数量: 15 个                                           ║
║ 文件管理器: 已就绪                                             ║
║ 事件系统: 已启用                                               ║
╚══════════════════════════════════════════════════════════════╝
```

### 2. Web界面使用示例

#### 访问Web界面

1. 启动Web服务: `python main.py` 选择模式2
2. 打开浏览器访问: `http://localhost:8080`
3. 在聊天窗口输入需求

#### 常见任务示例

**代码生成**:
```
用户输入: "创建一个Python计算器程序"
系统响应: 
- 分析任务需求
- 生成执行计划
- 调用代码生成工具
- 返回完整的Python计算器代码
```

**数据分析**:
```
用户输入: "分析销售数据并生成图表"
系统响应:
- 读取数据文件
- 执行数据分析
- 生成可视化图表
- 提供分析报告
```

**文档处理**:
```
用户输入: "将PDF转换为Word文档"
系统响应:
- 读取PDF文件
- 提取文本内容
- 生成Word文档
- 保持格式一致性
```

### 3. API使用示例

#### 使用Python客户端

```python
import asyncio
import aiohttp
import json

async def analyze_task(user_input, user_id="test_user"):
    """分析任务示例"""
    url = "http://localhost:8080/api/tasks/analyze"
    data = {
        "user_input": user_input,
        "user_id": user_id
    }
    
    async with aiohttp.ClientSession() as session:
        async with session.post(url, json=data) as response:
            result = await response.json()
            return result

async def execute_task(task_plan, user_id="test_user"):
    """执行任务示例"""
    url = "http://localhost:8080/api/tasks/execute"
    data = {
        "task_plan": task_plan,
        "user_id": user_id
    }
    
    async with aiohttp.ClientSession() as session:
        async with session.post(url, json=data) as response:
            result = await response.json()
            return result

# 使用示例
async def main():
    # 分析任务
    task_result = await analyze_task("生成一个Python程序")
    print(f"任务分析结果: {task_result}")
    
    # 执行任务
    if task_result["success"]:
        execution_result = await execute_task(task_result["data"])
        print(f"执行结果: {execution_result}")

# 运行示例
asyncio.run(main())
```

#### 使用curl命令

```bash
# 分析任务
curl -X POST http://localhost:8080/api/tasks/analyze \
  -H "Content-Type: application/json" \
  -d '{"user_input": "生成一个Python程序", "user_id": "test_user"}'

# 获取任务状态
curl -X GET http://localhost:8080/api/tasks/task_123456/status

# 下载文件
curl -X GET http://localhost:8080/api/files/download/file_001 \
  -o downloaded_file.py
```

## ❓ 常见问题

### 1. 安装问题

**Q: pip install 时出现权限错误**
```bash
# 解决方案：使用用户安装
pip install --user -r requirements.txt

# 或者使用虚拟环境
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

**Q: 缺少系统依赖**
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install build-essential python3-dev libffi-dev libssl-dev

# CentOS/RHEL
sudo yum groupinstall "Development Tools"
sudo yum install python3-devel openssl-devel libffi-devel
```

### 2. 配置问题

**Q: OpenAI API调用失败**
```python
# 检查API配置
LLM_CONFIG = {
    "api_key": "sk-your-actual-api-key",  # 确保API密钥正确
    "base_url": "https://api.openai.com/v1",  # 确保URL正确
    "model_name": "gpt-4",  # 确保模型名称正确
}
```

**Q: MCP工具加载失败**
```bash
# 检查MCP服务器状态
python communication/mcp_server.py

# 验证MCP配置
cat communication/mcp_config.json
```

### 3. 运行时问题

**Q: 内存不足错误**
```bash
# 增加虚拟内存
sudo swapon -s
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

**Q: 端口占用问题**
```bash
# 查找占用端口的进程
netstat -tulpn | grep :8080
lsof -i :8080

# 杀死占用进程
kill -9 <pid>

# 或修改配置使用其他端口
WEB_CONFIG["port"] = 8081
```

### 4. 性能问题

**Q: 响应速度慢**
```python
# 优化配置
LLM_CONFIG["temperature"] = 0.1  # 降低随机性
LLM_CONFIG["max_tokens"] = 2000  # 减少token数量

# 启用缓存
CACHE_CONFIG = {
    "enabled": True,
    "ttl": 3600,  # 1小时
    "max_size": 1000
}
```

**Q: 内存使用过高**
```python
# 限制并发数
EXECUTOR_CONFIG = {
    "max_concurrent_tasks": 3,
    "task_timeout": 300,
    "memory_limit": "1GB"
}
```

## 📊 监控运维

### 1. 日志监控

#### 查看日志

```bash
# 查看应用日志
tail -f logs/app.log

# 查看错误日志
grep ERROR logs/app.log

# 查看特定时间段日志
grep "2024-01-01" logs/app.log
```

#### 日志分析

```bash
# 统计错误数量
grep -c ERROR logs/app.log

# 查看最频繁的错误
grep ERROR logs/app.log | sort | uniq -c | sort -nr

# 监控关键指标
grep "task_complete" logs/app.log | wc -l  # 完成任务数
grep "task_failed" logs/app.log | wc -l   # 失败任务数
```

### 2. 性能监控

#### 系统资源监控

```bash
# 监控脚本
#!/bin/bash
# monitor.sh

echo "=== 系统资源监控 ===" 
echo "时间: $(date)"
echo "CPU使用率:"
top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1

echo "内存使用情况:"
free -h

echo "磁盘使用情况:"
df -h

echo "进程信息:"
ps aux | grep python | grep -v grep
```

#### 应用监控

```python
# 监控脚本
import psutil
import requests
import time

def monitor_app():
    """监控应用状态"""
    try:
        # 检查Web服务
        response = requests.get("http://localhost:8080/health")
        if response.status_code == 200:
            print("✅ Web服务正常")
        else:
            print("❌ Web服务异常")
    except:
        print("❌ Web服务无响应")
    
    # 检查系统资源
    cpu_percent = psutil.cpu_percent()
    memory_percent = psutil.virtual_memory().percent
    disk_percent = psutil.disk_usage('/').percent
    
    print(f"CPU使用率: {cpu_percent}%")
    print(f"内存使用率: {memory_percent}%")
    print(f"磁盘使用率: {disk_percent}%")

if __name__ == "__main__":
    while True:
        monitor_app()
        time.sleep(60)  # 每分钟检查一次
```

### 3. 备份策略

#### 数据备份

```bash
#!/bin/bash
# backup.sh

BACKUP_DIR="/backup/digital-employee"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据文件
tar -czf $BACKUP_DIR/data_$DATE.tar.gz data/

# 备份配置文件
tar -czf $BACKUP_DIR/config_$DATE.tar.gz config/

# 备份日志文件
tar -czf $BACKUP_DIR/logs_$DATE.tar.gz logs/

# 清理旧备份（保留7天）
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete

echo "备份完成: $DATE"
```

#### 自动备份

```bash
# 添加到crontab
crontab -e

# 每天凌晨2点备份
0 2 * * * /path/to/backup.sh >> /var/log/backup.log 2>&1
```

### 4. 自动重启

#### 进程监控脚本

```bash
#!/bin/bash
# watchdog.sh

SERVICE_NAME="digital-employee"
SERVICE_CMD="python main.py"
SERVICE_DIR="/path/to/digital-employee"

while true; do
    # 检查进程是否运行
    if ! pgrep -f "$SERVICE_CMD" > /dev/null; then
        echo "$(date): $SERVICE_NAME 已停止，正在重启..."
        
        cd $SERVICE_DIR
        source venv/bin/activate
        nohup $SERVICE_CMD > logs/service.log 2>&1 &
        
        echo "$(date): $SERVICE_NAME 已重启"
    fi
    
    sleep 30  # 每30秒检查一次
done
```

#### 使用systemd管理服务

创建服务文件 `/etc/systemd/system/digital-employee.service`:

```ini
[Unit]
Description=Digital Employee Service
After=network.target

[Service]
Type=simple
User=your-user
WorkingDirectory=/path/to/digital-employee
ExecStart=/path/to/digital-employee/venv/bin/python main.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启用服务：

```bash
sudo systemctl enable digital-employee
sudo systemctl start digital-employee
sudo systemctl status digital-employee
```

### 5. 健康检查

#### 健康检查端点

```python
# 在Web应用中添加健康检查端点
@app.get("/health")
async def health_check():
    """健康检查端点"""
    return {
        "status": "healthy",
        "timestamp": datetime.now().isoformat(),
        "version": "1.0.0",
        "services": {
            "llm": "connected",
            "mcp": "connected",
            "storage": "available"
        }
    }
```

#### 外部监控

```bash
# 使用外部监控工具检查
curl -f http://localhost:8080/health || echo "Service down"
```

通过这些监控和运维措施，可以确保数字员工系统的稳定运行和高可用性。 