<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manus AI - {{ user_id }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
    <style>
        .chat-container {
            height: calc(100vh - 60px);
        }
        
        .chat-sidebar {
            height: 100%;
            background: #f8f9fa;
            border-right: 1px solid #dee2e6;
        }
        
        .chat-main {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 1rem;
            background: #ffffff;
            max-height: calc(100vh - 200px);
            scroll-behavior: smooth;
            scrollbar-width: thin;
            scrollbar-color: #007bff #f8f9fa;
        }
        
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: #007bff;
            border-radius: 4px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #0056b3;
        }
        
        .chat-input {
            border-top: 1px solid #dee2e6;
            padding: 1rem;
            background: #f8f9fa;
            flex-shrink: 0;
        }
        
        .monitor-panel {
            height: 100%;
            background: #fff;
            border-left: 1px solid #dee2e6;
            overflow-y: auto;
        }
        
        .message {
            margin-bottom: 0.75rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .message.user {
            text-align: right;
        }
        
        .message.assistant {
            text-align: left;
        }
        
        .message-bubble {
            max-width: 65%;
            padding: 0.5rem 0.75rem;
            border-radius: 0.75rem;
            display: inline-block;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
            font-size: 0.9rem;
            line-height: 1.4;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .message.user .message-bubble {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border-radius: 0.75rem 0.75rem 0.2rem 0.75rem;
        }
        
        .message.assistant .message-bubble {
            background: white;
            color: #333;
            border: 1px solid #e1e5e9;
            border-radius: 0.75rem 0.75rem 0.75rem 0.2rem;
        }
        
        .message.system .message-bubble {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            text-align: center;
            max-width: 90%;
            margin: 0 auto;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            padding: 0.4rem 0.6rem;
        }
        
        /* æ¶ˆæ¯å¤´éƒ¨ä¿¡æ¯æ ·å¼ */
        .message-header {
            font-size: 0.75rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .message.user .message-header {
            justify-content: flex-end;
        }
        
        .message.assistant .message-header {
            justify-content: flex-start;
        }
        
        /* ä¼˜åŒ–ä»£ç å—æ ·å¼ */
        .message-bubble pre {
            background: #f8f9fa !important;
            border: 1px solid #e9ecef !important;
            border-radius: 0.375rem !important;
            padding: 0.5rem !important;
            margin: 0.5rem 0 !important;
            font-size: 0.8rem !important;
            overflow-x: auto;
        }
        
        .message.user .message-bubble pre {
            background: rgba(255, 255, 255, 0.1) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            color: white !important;
        }
        
        .message-bubble code {
            background: #f8f9fa !important;
            color: #e83e8c !important;
            padding: 0.1rem 0.3rem !important;
            border-radius: 0.25rem !important;
            font-size: 0.85em !important;
        }
        
        .message.user .message-bubble code {
            background: rgba(255, 255, 255, 0.2) !important;
            color: #ffd700 !important;
        }
        
        .typing-indicator {
            display: none;
            margin-bottom: 1rem;
        }
        
        .typing-dots {
            display: inline-block;
            position: relative;
            width: 80px;
            height: 20px;
        }
        
        .typing-dots div {
            position: absolute;
            top: 8px;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #007bff;
            animation: typing 1.4s infinite ease-in-out both;
        }
        
        .typing-dots div:nth-child(1) { left: 8px; animation-delay: -0.32s; }
        .typing-dots div:nth-child(2) { left: 20px; animation-delay: -0.16s; }
        .typing-dots div:nth-child(3) { left: 32px; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        .task-progress {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 0.375rem;
            padding: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .step-item {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 0.25rem;
            border-left: 4px solid #6c757d;
        }
        
        .step-item.running {
            border-left-color: #007bff;
            background: #e7f3ff;
        }
        
        .step-item.completed {
            border-left-color: #28a745;
            background: #d4edda;
        }
        
        .step-item.failed {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        
        /* æµç¨‹æ ‘æ ·å¼ */
        .process-tree {
            background: #f8f9fa;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        .process-node {
            position: relative;
            margin: 0.5rem 0;
            padding: 0.75rem;
            border-radius: 0.375rem;
            border: 2px solid #e9ecef;
            background: white;
            transition: all 0.3s ease;
        }
        
        .process-node.running {
            border-color: #007bff;
            background: linear-gradient(135deg, #e7f3ff, #f0f8ff);
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2);
            animation: pulse-blue 2s infinite;
        }
        
        .process-node.completed {
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda, #e8f5e8);
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2);
        }
        
        .process-node.warning {
            border-color: #ffc107;
            background: linear-gradient(135deg, #fff3cd, #fef9e7);
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.2);
        }
        
        .process-node.failed {
            border-color: #dc3545;
            background: linear-gradient(135deg, #f8d7da, #fdf2f2);
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.2);
        }
        
        @keyframes pulse-blue {
            0% { box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2); }
            50% { box-shadow: 0 4px 16px rgba(0, 123, 255, 0.4); }
            100% { box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2); }
        }
        
        .process-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 1rem;
        }
        
        .process-icon {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.75rem;
            font-size: 0.9rem;
            background: #6c757d;
            color: white;
        }
        
        .process-node.running .process-icon {
            background: linear-gradient(135deg, #007bff, #0056b3);
        }
        
        .process-node.completed .process-icon {
            background: linear-gradient(135deg, #28a745, #1e7e34);
        }
        
        .process-node.warning .process-icon {
            background: linear-gradient(135deg, #ffc107, #e0a800);
        }
        
        .process-node.failed .process-icon {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }
        
        .process-title {
            flex: 1;
            color: #333;
        }
        
        .process-time {
            font-size: 0.8rem;
            color: #6c757d;
            margin-left: auto;
        }
        
        .process-details {
            margin-left: 2.75rem;
            color: #666;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .sub-steps {
            margin-left: 2.75rem;
            margin-top: 0.5rem;
        }
        
        .sub-step {
            position: relative;
            margin: 0.25rem 0;
            padding: 0.5rem 0.75rem;
            border-radius: 0.25rem;
            border-left: 3px solid #dee2e6;
            background: rgba(255, 255, 255, 0.7);
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }
        
        .sub-step.running {
            border-left-color: #007bff;
            background: rgba(0, 123, 255, 0.1);
            animation: sub-pulse 1.5s infinite;
        }
        
        .sub-step.completed {
            border-left-color: #28a745;
            background: rgba(40, 167, 69, 0.1);
        }
        
        .sub-step.warning {
            border-left-color: #ffc107;
            background: rgba(255, 193, 7, 0.1);
        }
        
        .sub-step.failed {
            border-left-color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
        }
        
        .sub-step-content {
            display: flex;
            align-items: center;
        }
        
        .sub-step-icon {
            margin-right: 0.5rem;
            font-size: 0.8rem;
        }
        
        .sub-step-text {
            flex: 1;
        }
        
        .sub-step-time {
            font-size: 0.7rem;
            color: #6c757d;
            margin-left: auto;
        }
        
        /* è¿æ¥çº¿æ ·å¼ */
        .process-connector {
            position: absolute;
            left: 1rem;
            top: 3rem;
            bottom: -0.5rem;
            width: 2px;
            background: linear-gradient(to bottom, #dee2e6 0%, transparent 100%);
        }
        
        .process-node:last-child .process-connector {
            display: none;
        }
        
        /* æ‰§è¡ŒçŠ¶æ€æ€»è§ˆ */
        .execution-summary {
            background: white;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid #e9ecef;
        }
        
        .summary-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
            font-weight: 600;
            color: #333;
        }
        
        .summary-progress {
            display: flex;
            height: 0.5rem;
            border-radius: 0.25rem;
            background: #e9ecef;
            margin-bottom: 0.5rem;
            overflow: hidden;
        }
        
        .progress-segment {
            transition: all 0.5s ease;
        }
        
        .progress-segment.completed {
            background: linear-gradient(90deg, #28a745, #20c997);
        }
        
        .progress-segment.running {
            background: linear-gradient(90deg, #007bff, #17a2b8);
            animation: progress-pulse 1.5s infinite;
        }
        
        .progress-segment.pending {
            background: #e9ecef;
        }
        
        @keyframes progress-pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
        
        .summary-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        /* æ­¥éª¤åˆ†ç±»æ ·å¼ */
        .step-category {
            margin-bottom: 0.75rem;
        }
        
        .step-category-header {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 0.4rem 0.6rem;
            border-radius: 0.25rem;
            border-left: 3px solid #007bff;
            margin-bottom: 0.25rem;
            font-size: 0.85rem;
        }
        
        .step-category-content {
            padding-left: 0.5rem;
        }
        
        .step-category-content .step-item {
            margin-bottom: 0.25rem;
            padding: 0.3rem 0.5rem;
            font-size: 0.8rem;
            border-left-width: 2px;
        }
        
        .step-category-content .step-item.running {
            border-left-color: #007bff;
            background: #e7f3ff;
            animation: pulse 2s infinite;
        }
        
        .step-category-content .step-item.completed {
            border-left-color: #28a745;
            background: #d4edda;
        }
        
        .step-category-content .step-item.failed {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        
        .step-category-content .step-item.warning {
            border-left-color: #ffc107;
            background: #fff3cd;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .monitor-log {
            height: 300px;
            overflow-y: auto;
            background: #1a1a1a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            padding: 1rem;
            border-radius: 0.375rem;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 0.5rem;
        }
        
        .status-online { background: #28a745; }
        .status-busy { background: #ffc107; }
        .status-offline { background: #6c757d; }
        
        /* èŠå¤©ä¸­çš„æ—¥å¿—æ¶ˆæ¯æ ·å¼ */
        .message.log-message {
            margin-bottom: 0.3rem;
            opacity: 0.85;
        }
        
        .message.log-message .message-bubble {
            font-size: 0.8rem;
            padding: 0.4rem 0.6rem;
            margin: 0 1rem;
            border-radius: 0.3rem;
            position: relative;
        }
        
        .message.log-message .log-header {
            font-weight: 500;
            opacity: 0.8;
        }
        
        .message.log-message .log-content {
            margin-top: 2px;
        }
        
        /* æ—¥å¿—æ¶ˆæ¯æ‚¬åœæ•ˆæœ */
        .message.log-message:hover {
            opacity: 1;
            transform: translateX(2px);
            transition: all 0.2s ease;
        }
        
        /* ä¸åŒæ—¥å¿—çº§åˆ«çš„ç‰¹æ®Šæ ·å¼ */
        .message.log-message.log-error .message-bubble {
            border-left-width: 4px;
            box-shadow: 0 1px 3px rgba(220, 53, 69, 0.2);
        }
        
        .message.log-message.log-warning .message-bubble {
            border-left-width: 4px;
            box-shadow: 0 1px 3px rgba(255, 193, 7, 0.2);
        }
        
        /* æ–‡ä»¶æ ·å¼ */
        .file-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
        }
        
        .file-item:hover {
            background: #e9ecef;
            border-color: #007bff;
        }
        
        .file-icon {
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #007bff;
            color: white;
            border-radius: 0.25rem;
            margin-right: 0.75rem;
            flex-shrink: 0;
        }
        
        .file-info {
            flex: 1;
            min-width: 0;
        }
        
        .file-name {
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
            word-break: break-all;
        }
        
        .file-meta {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .file-actions {
            display: flex;
            gap: 0.25rem;
            flex-shrink: 0;
        }
        
        .download-package {
            background: linear-gradient(135deg, #28a745, #20c997);
            border: none;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: all 0.2s ease;
            width: 100%;
            margin-top: 1rem;
        }
        
        .download-package:hover {
            background: linear-gradient(135deg, #218838, #1e7e34);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        /* å“åº”å¼å¤„ç† */
        @media (max-width: 768px) {
            .chat-container {
                flex-direction: column;
                height: auto;
            }
            
            .chat-main {
                height: 70vh;
            }
            
            .chat-messages {
                max-height: 60vh;
                padding: 0.5rem;
            }
            
            .monitor-panel {
                height: 30vh;
                border-left: none;
                border-top: 1px solid #dee2e6;
            }
            
            .message-bubble {
                max-width: 85%;
                font-size: 0.85rem;
                padding: 0.4rem 0.6rem;
            }
            
            .message-header {
                font-size: 0.7rem;
            }
            
            .message.log-message .message-bubble {
                margin: 0 0.5rem;
                font-size: 0.75rem;
            }
        }
        
        @media (max-width: 480px) {
            .message-bubble {
                max-width: 95%;
                font-size: 0.8rem;
            }
            
            .chat-messages {
                padding: 0.25rem;
            }
            
            .message.log-message .message-bubble {
                margin: 0 0.25rem;
                font-size: 0.7rem;
                padding: 0.3rem 0.4rem;
            }
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        .typing-cursor {
            color: #007bff;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
            <div class="container-fluid">
                <a class="navbar-brand" href="/">
                    <i class="bi bi-robot"></i>
                    Manus AI
                </a>
                <div class="navbar-nav me-auto">
                    <span class="navbar-text">
                        <i class="bi bi-person-circle"></i>
                        ç”¨æˆ·: {{ user_id }}
                    </span>
                </div>
                <div class="navbar-nav">
                    <span class="navbar-text">
                        <span class="status-indicator" id="connectionStatus"></span>
                        <span id="connectionText">è¿æ¥ä¸­...</span>
                    </span>
                </div>
            </div>
        </nav>

        <!-- ä¸»è¦èŠå¤©ç•Œé¢ -->
        <div class="row chat-container">
            <!-- å·¦ä¾§èŠå¤©åŒºåŸŸ -->
            <div class="col-lg-9 p-0">
                <div class="chat-main">
                    <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
                    <div class="chat-messages" id="chatMessages">
                        <div class="message system">
                            <div class="message-bubble">
                                <i class="bi bi-info-circle"></i>
                                æ¬¢è¿ä½¿ç”¨Manus AIç³»ç»Ÿï¼è¯·è¾“å…¥æ‚¨çš„ä»»åŠ¡éœ€æ±‚ã€‚
                            </div>
                        </div>
                    </div>
                    
                    <!-- è¾“å…¥æ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨ -->
                    <div class="typing-indicator" id="typingIndicator">
                        <div class="message assistant">
                            <div class="message-header">
                                <i class="bi bi-robot"></i>
                                <span>AIåŠ©æ‰‹</span>
                            </div>
                            <div class="message-bubble">
                                <div class="typing-dots">
                                    <div></div>
                                    <div></div>
                                    <div></div>
                                </div>
                                <span style="margin-left: 2rem; font-size: 0.85rem; color: #6c757d;">æ­£åœ¨æ€è€ƒ...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- è¾“å…¥åŒºåŸŸ -->
                    <div class="chat-input">
                        <form id="chatForm">
                            <div class="input-group">
                                <input type="text" class="form-control" id="messageInput" 
                                       placeholder="è¯·è¾“å…¥æ‚¨çš„ä»»åŠ¡æˆ–é—®é¢˜..." required>
                                <button class="btn btn-primary" type="submit" id="sendBtn">
                                    <i class="bi bi-send"></i>
                                    å‘é€
                                </button>
                            </div>
                        </form>
                        
                        <!-- å¿«é€Ÿæ“ä½œæŒ‰é’® -->
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-secondary me-2 quick-task" 
                                    data-task="ç”Ÿæˆä¸€ä¸ªPythonç®€å•è®¡ç®—å™¨ç¨‹åº,ä¸å…è®¸è¿½é—®">
                                <i class="bi bi-code"></i> ä»£ç ç”Ÿæˆ
                            </button>
                            <button class="btn btn-sm btn-outline-secondary me-2 quick-task" 
                                    data-task="æœç´¢æœ€æ–°AIæŠ€æœ¯è¶‹åŠ¿,ä¸å…è®¸è¿½é—®">
                                <i class="bi bi-search"></i> ä¿¡æ¯æœç´¢
                            </button>
                            <button class="btn btn-sm btn-outline-secondary me-2 quick-task" 
                                    data-task="ç”Ÿæˆä¸€å¼ ç§‘æŠ€èƒŒæ™¯å›¾ç‰‡,ä¸å…è®¸è¿½é—®">
                                <i class="bi bi-image"></i> å›¾åƒç”Ÿæˆ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å³ä¾§ç›‘æ§é¢æ¿ -->
            <div class="col-lg-3 p-0">
                <div class="monitor-panel">
                    <!-- ä»»åŠ¡çŠ¶æ€é¢æ¿ -->
                    <div class="p-3 border-bottom">
                        <h6 class="mb-2">
                            <i class="bi bi-activity"></i>
                            ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€
                        </h6>
                        <div id="taskStatus">
                            <div class="text-muted">
                                <i class="bi bi-hourglass"></i>
                                ç­‰å¾…ä»»åŠ¡è¾“å…¥...
                            </div>
                        </div>
                    </div>
                    
                    <!-- ä»»åŠ¡è¿›åº¦ -->
                    <div class="p-3 border-bottom">
                        <h6 class="mb-2">
                            <i class="bi bi-list-check"></i>
                            æ‰§è¡Œæ­¥éª¤
                        </h6>
                        
                        <!-- æ‰§è¡ŒçŠ¶æ€æ€»è§ˆ -->
                        <div class="execution-summary" id="executionSummary" style="display: none;">
                            <div class="summary-header">
                                <i class="bi bi-graph-up me-2"></i>
                                <span>æ‰§è¡Œè¿›åº¦æ€»è§ˆ</span>
                            </div>
                            <div class="summary-progress" id="progressBar"></div>
                            <div class="summary-stats" id="progressStats">
                                <span>å·²å®Œæˆ: 0</span>
                                <span>è¿›è¡Œä¸­: 0</span>
                                <span>å¾…æ‰§è¡Œ: 0</span>
                            </div>
                        </div>
                        
                        <!-- æµç¨‹æ ‘ -->
                        <div class="process-tree" id="taskSteps">
                            <div class="text-muted text-center">
                                <i class="bi bi-hourglass-split me-2"></i>
                                æ­£åœ¨åˆ†æä»»åŠ¡...
                            </div>
                        </div>
                    </div>
                    
                    <!-- ç”Ÿæˆæ–‡ä»¶ -->
                    <div class="p-3 border-bottom">
                        <h6 class="mb-2">
                            <i class="bi bi-file-earmark"></i>
                            ç”Ÿæˆæ–‡ä»¶
                        </h6>
                        <div id="generatedFiles">
                            <div class="text-muted text-center">
                                æš‚æ— ç”Ÿæˆæ–‡ä»¶
                            </div>
                        </div>
                    </div>
                    
                    <!-- ç³»ç»Ÿè®¾ç½® -->
                    <div class="p-3">
                        <h6 class="mb-2">
                            <i class="bi bi-gear"></i>
                            ç³»ç»Ÿè®¾ç½®
                        </h6>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="debugModeSwitch" onchange="toggleDebugMode()">
                            <label class="form-check-label" for="debugModeSwitch">
                                æ˜¾ç¤ºè¯¦ç»†æ—¥å¿—
                            </label>
                        </div>
                        <small class="text-muted">å¼€å¯åå°†åœ¨å¯¹è¯ä¸­æ˜¾ç¤ºç³»ç»Ÿè¯¦ç»†è¿è¡Œæ—¥å¿—</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const userId = "{{ user_id }}";
        const sessionId = "{{ session_id }}";
        let websocket = null;
        let isConnected = false;
        let currentTaskId = null;
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
        
        // åˆå§‹åŒ–åº”ç”¨
        function initializeApp() {
            console.log('åˆå§‹åŒ–Manus AIç³»ç»Ÿ...');
            
            // åˆå§‹åŒ–è°ƒè¯•æ¨¡å¼
            const savedDebugMode = localStorage.getItem('debugMode');
            window.debugMode = savedDebugMode === 'true';
            document.getElementById('debugModeSwitch').checked = window.debugMode;
            
            connectWebSocket();
            setupEventListeners();
            
            // æ£€æŸ¥URLå‚æ•°ä¸­çš„é¢„è®¾ä»»åŠ¡
            const urlParams = new URLSearchParams(window.location.search);
            const task = urlParams.get('task');
            if (task) {
                document.getElementById('messageInput').value = decodeURIComponent(task);
                // å»¶è¿Ÿè‡ªåŠ¨å‘é€
                setTimeout(() => {
                    if (isConnected) {
                        submitMessage();
                    }
                }, 1000);
            }
        }
        
        // å»ºç«‹WebSocketè¿æ¥
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/${encodeURIComponent(userId)}`;
            
            console.log('è¿æ¥WebSocket:', wsUrl);
            websocket = new WebSocket(wsUrl);
            
            websocket.onopen = function(event) {
                isConnected = true;
                updateConnectionStatus('online', 'å·²è¿æ¥');
                addLogMessage('> ğŸ”— WebSocket è¿æ¥å·²å»ºç«‹');
                console.log('WebSocketè¿æ¥æˆåŠŸ');
            };
            
            websocket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log('æ”¶åˆ°WebSocketæ¶ˆæ¯:', data);
                handleWebSocketMessage(data);
            };
            
            websocket.onclose = function(event) {
                isConnected = false;
                updateConnectionStatus('offline', 'è¿æ¥æ–­å¼€');
                addLogMessage('> ğŸ”— WebSocket è¿æ¥å·²æ–­å¼€ï¼Œ5ç§’åé‡è¿...');
                console.log('WebSocketè¿æ¥æ–­å¼€');
                
                // 5ç§’åå°è¯•é‡è¿
                setTimeout(connectWebSocket, 5000);
            };
            
            websocket.onerror = function(error) {
                console.error('WebSocketé”™è¯¯:', error);
                updateConnectionStatus('offline', 'è¿æ¥é”™è¯¯');
                addLogMessage('> âŒ WebSocket è¿æ¥é”™è¯¯');
            };
        }
        
        // å¤„ç†WebSocketæ¶ˆæ¯
        function handleWebSocketMessage(data) {
            console.log('ğŸ”„ å¤„ç†WebSocketæ¶ˆæ¯:', data.type, data);
            
            switch(data.type) {
                case 'system':
                    addSystemMessage(data.message);
                    addLogMessage(`> ç³»ç»Ÿ: ${data.message}`);
                    break;
                    
                case 'new_message':
                    addMessage(data.message);
                    break;
                    
                case 'stream_output':
                    // å¤„ç†æµå¼è¾“å‡ºæ¶ˆæ¯
                    addStreamOutput(data.message);
                    // å®Œå…¨ä¸åœ¨å®æ—¶æ—¥å¿—ä¸­è®°å½•æµå¼è¾“å‡ºå†…å®¹
                    break;
                    
                case 'task_start':
                    finishStreamOutput(); // å®Œæˆä¹‹å‰çš„æµå¼è¾“å‡º
                    showTypingIndicator();
                    updateTaskStatus('åˆ†æä¸­', 'warning');
                    addLogMessage('> ğŸ“‹ ä»»åŠ¡å¼€å§‹æ‰§è¡Œ');
                    // é‡ç½®æ­¥éª¤æ˜¾ç¤º
                    resetTaskSteps();
                    break;
                    
                case 'task_progress':
                    updateTaskStatus(data.message, 'info');
                    // åªè®°å½•ç‰¹å®šé˜¶æ®µçš„è¿›åº¦ï¼Œé¿å…ä¸detailed_progressé‡å¤
                    if (data.stage && ['executing', 'collecting'].includes(data.stage)) {
                        addLogMessage(`> ğŸ“Š ${data.message}`);
                    }
                    if (data.stage) {
                        updateTaskStage(data.stage);
                    }
                    break;
                
                case 'detailed_progress':
                    // å¤„ç†è¯¦ç»†è¿›åº¦äº‹ä»¶ï¼ˆé«˜ä¼˜å…ˆçº§å¤„ç†ï¼‰
                    console.log('ğŸ¯ è¯¦ç»†è¿›åº¦äº‹ä»¶:', data.event_type, data.data);
                    handleDetailedProgress(data);
                    // åªä¸ºå…³é”®äº‹ä»¶æ·»åŠ æ—¥å¿—ï¼Œé¿å…é‡å¤
                    const keyEvents = [
                        'task_analysis_start', 
                        'plan_generation_start', 
                        'task_start', 
                        'step_start',
                        'result_collection_start',
                        'report_generation_start'
                    ];
                    if (keyEvents.includes(data.event_type)) {
                        const message = data.data.message || data.stage || data.event_type;
                        addLogMessage(`> ğŸ¯ ${message}`);
                    }
                    // ç«‹å³å¼ºåˆ¶UIæ›´æ–°
                    forceUIUpdate();
                    break;
                    
                case 'task_complete':
                    console.log('ä»»åŠ¡å®Œæˆï¼Œæ•°æ®:', data);
                    finishStreamOutput(); // å®Œæˆæµå¼è¾“å‡º
                    hideTypingIndicator();
                    updateTaskStatus('ä»»åŠ¡å®Œæˆ', 'success');
                    addLogMessage('> âœ… ä»»åŠ¡æ‰§è¡Œå®Œæˆ');
                    
                    // ä¿å­˜task_id
                    if (data.task_id) {
                        currentTaskId = data.task_id;
                        console.log('ä¿å­˜å½“å‰ä»»åŠ¡ID:', currentTaskId);
                    }
                    
                    // å¤„ç†æ–‡ä»¶æ˜¾ç¤º
                    handleTaskFiles(data);
                    break;
                    
                case 'error':
                    finishStreamOutput(); // å®Œæˆæµå¼è¾“å‡º
                    hideTypingIndicator();
                    updateTaskStatus('æ‰§è¡Œå¤±è´¥', 'danger');
                    addLogMessage(`> âŒ é”™è¯¯: ${data.message}`);
                    break;
                    
                case 'chat_history':
                    loadChatHistory(data.messages);
                    addLogMessage(`> ğŸ“š åŠ è½½å†å²è®°å½• ${data.showing_recent}/${data.total_messages} æ¡`);
                    break;
                    
                case 'log_stream':
                    // å¤„ç†æµå¼æ—¥å¿—æ¶ˆæ¯
                    handleLogStream(data);
                    break;
                    
                case 'pong':
                    // å¿ƒè·³å“åº”
                    console.log('ğŸ“¡ æ”¶åˆ°å¿ƒè·³å“åº”');
                    break;
                    
                default:
                    console.log('â“ æœªçŸ¥æ¶ˆæ¯ç±»å‹:', data.type, data);
            }
        }
        
        // å¤„ç†æµå¼è¾“å‡ºçš„å…¨å±€å˜é‡
        let currentStreamMessage = null;
        let streamAccumulator = '';
        let streamStartTime = null;
        
        // æ·»åŠ æµå¼è¾“å‡ºåˆ°èŠå¤©åŒºåŸŸ
        function addStreamOutput(content) {
            const messagesContainer = document.getElementById('chatMessages');
            
            // å¦‚æœæ²¡æœ‰å½“å‰çš„æµå¼æ¶ˆæ¯ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„
            if (!currentStreamMessage) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message assistant';
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <i class="bi bi-robot"></i>
                        <span>AIåŠ©æ‰‹</span>
                        <span class="ms-auto">${new Date().toLocaleTimeString()}</span>
                    </div>
                    <div class="message-bubble">
                        <div class="message-content stream-content"></div>
                    </div>
                `;
                messagesContainer.appendChild(messageDiv);
                currentStreamMessage = messageDiv.querySelector('.stream-content');
                streamAccumulator = '';
                streamStartTime = Date.now();
                
                // åªåœ¨å¼€å§‹æµå¼è¾“å‡ºæ—¶è®°å½•ä¸€æ¬¡ç®€æ´çš„æ—¥å¿—
                addLogMessage('> ğŸ¤– AIæ­£åœ¨å›å¤...');
            }
            
            // ç´¯ç§¯å†…å®¹
            streamAccumulator += content;
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«å›¾è¡¨HTMLå†…å®¹
            if (streamAccumulator.includes('plotly') || streamAccumulator.includes('<!DOCTYPE html>')) {
                // å¦‚æœæ˜¯å›¾è¡¨HTMLå†…å®¹ï¼Œç›´æ¥ä½¿ç”¨iframeæ˜¾ç¤º
                if (streamAccumulator.trim().startsWith('<!DOCTYPE html>') || streamAccumulator.trim().startsWith('<html')) {
                    const iframe = document.createElement('iframe');
                    iframe.style.width = '100%';
                    iframe.style.height = '500px';
                    iframe.style.border = '1px solid #ddd';
                    iframe.style.borderRadius = '8px';
                    iframe.srcdoc = streamAccumulator;
                    
                    const container = document.createElement('div');
                    container.className = 'chart-container mb-3';
                    container.appendChild(iframe);
                    
                    const caption = document.createElement('div');
                    caption.className = 'text-muted small text-center mt-2';
                    caption.innerHTML = '<i class="bi bi-bar-chart"></i> äº¤äº’å¼å›¾è¡¨';
                    container.appendChild(caption);
                    
                    currentStreamMessage.innerHTML = container.outerHTML;
                } else {
                    // æ›´æ–°æ˜¾ç¤ºå†…å®¹ï¼Œåº”ç”¨åŸºæœ¬æ ¼å¼åŒ–
                    const formattedContent = formatMessageContent(streamAccumulator);
                    currentStreamMessage.innerHTML = formattedContent;
                }
            } else {
                // æ›´æ–°æ˜¾ç¤ºå†…å®¹ï¼Œåº”ç”¨åŸºæœ¬æ ¼å¼åŒ–
                const formattedContent = formatMessageContent(streamAccumulator);
                currentStreamMessage.innerHTML = formattedContent;
            }
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            scrollToBottom();
        }
        
        // å®Œæˆæµå¼è¾“å‡º
        function finishStreamOutput() {
            if (currentStreamMessage) {
                // æ·»åŠ å®Œæˆæ ·å¼
                currentStreamMessage.style.animation = 'fadeIn 0.3s ease-in';
                
                // è®°å½•ç®€æ´çš„å®Œæˆæ—¥å¿—
                if (streamStartTime) {
                    const duration = ((Date.now() - streamStartTime) / 1000).toFixed(1);
                    addLogMessage(`> âœ… AIå›å¤å®Œæˆ (${duration}ç§’)`);
                }
                
                currentStreamMessage = null;
                streamAccumulator = '';
                streamStartTime = null;
            }
        }
        
        // å¼ºåˆ¶UIæ›´æ–°
        function forceUIUpdate() {
            // å¼ºåˆ¶é‡ç»˜
            document.getElementById('taskSteps').offsetHeight;
        }
        
        // å¤„ç†è¯¦ç»†è¿›åº¦äº‹ä»¶
        function handleDetailedProgress(data) {
            const eventType = data.event_type;
            const eventData = data.data || {};
            const message = eventData.message || data.stage || '';
            
            console.log('ğŸ¯ å¤„ç†è¯¦ç»†è¿›åº¦:', eventType, message);
            
            // æ ¹æ®äº‹ä»¶ç±»å‹å¤„ç†ä¸åŒçš„è¿›åº¦æ›´æ–°
            switch(eventType) {
                case 'task_analysis_start':
                    clearAndAddStep('ä»»åŠ¡åˆ†æ', 'å¼€å§‹åˆ†æç”¨æˆ·éœ€æ±‚...', 'running');
                    break;
                    
                case 'clarity_check_start':
                    addProcessNode('æ˜ç¡®åº¦æ£€æŸ¥', 'æ£€æŸ¥ä»»åŠ¡æ˜ç¡®åº¦...', 'running', true);
                    break;
                    
                case 'clarity_score':
                    const score = eventData.score || 0;
                    const needsClarification = eventData.needs_clarification || false;
                    const status = needsClarification ? 'warning' : 'completed';
                    updateProcessNode('æ˜ç¡®åº¦æ£€æŸ¥', `æ˜ç¡®åº¦è¯„åˆ†: ${(score * 100).toFixed(0)}%`, status);
                    break;
                    
                case 'plan_generation_start':
                    addProcessNode('è®¡åˆ’ç”Ÿæˆ', 'å¼€å§‹ç”Ÿæˆæ‰§è¡Œè®¡åˆ’...', 'running');
                    break;
                    
                case 'plan_step_generated':
                    const stepIndex = eventData.step_index || 0;
                    const totalSteps = eventData.total_steps || 0;
                    const stepDesc = eventData.step_description || '';
                    addSubStep('è®¡åˆ’ç”Ÿæˆ', `æ­¥éª¤ ${stepIndex + 1}/${totalSteps}: ${stepDesc}`, 'completed');
                    break;
                    
                case 'plan_generated':
                    const planSteps = eventData.total_steps || 0;
                    updateProcessNode('è®¡åˆ’ç”Ÿæˆ', `æ‰§è¡Œè®¡åˆ’ç”Ÿæˆå®Œæˆï¼Œå…± ${planSteps} ä¸ªæ­¥éª¤`, 'completed');
                    break;
                    
                case 'task_start':
                    addProcessNode('ä»»åŠ¡æ‰§è¡Œ', 'å¼€å§‹æ‰§è¡Œä»»åŠ¡...', 'running');
                    break;
                    
                case 'step_start':
                    const toolName = eventData.tool_name || '';
                    const description = eventData.description || message;
                    addSubStep('ä»»åŠ¡æ‰§è¡Œ', `${description} (å·¥å…·: ${toolName})`, 'running');
                    break;
                    
                case 'step_complete':
                    const stepStatus = eventData.status === 'completed' ? 'completed' : 'failed';
                    // æ›´æ–°æœ€åä¸€ä¸ªå­æ­¥éª¤çš„çŠ¶æ€
                    // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…å¯ä»¥è®°å½•å­æ­¥éª¤IDæ¥ç²¾ç¡®æ›´æ–°
                    break;
                    
                case 'result_collection_start':
                    addProcessNode('ç»“æœæ”¶é›†', 'å¼€å§‹æ”¶é›†æ‰§è¡Œç»“æœ...', 'running');
                    break;
                    
                case 'report_generation_start':
                    const formats = eventData.formats || [];
                    updateProcessNode('ç»“æœæ”¶é›†', `ç”Ÿæˆæ‰§è¡ŒæŠ¥å‘Š (${formats.join(', ')})...`, 'running');
                    break;
                    
                case 'report_saved':
                    const format = eventData.format || '';
                    addSubStep('ç»“æœæ”¶é›†', `${format.toUpperCase()} æŠ¥å‘Šå·²ä¿å­˜`, 'completed');
                    break;
                    
                case 'general_progress':
                    // é€šç”¨è¿›åº¦å¤„ç†
                    if (eventData.stage === 'plan_validation') {
                        addSubStep('è®¡åˆ’ç”Ÿæˆ', 'éªŒè¯è®¡åˆ’ä¸­çš„å·¥å…·å¯ç”¨æ€§...', 'completed');
                    }
                    break;
                    
                default:
                    console.log('â“ æœªå¤„ç†çš„è¯¦ç»†è¿›åº¦äº‹ä»¶:', eventType);
            }
        }
        
        // é‡ç½®ä»»åŠ¡æ­¥éª¤æ˜¾ç¤º
        function resetTaskSteps() {
            const stepsDiv = document.getElementById('taskSteps');
            const summaryDiv = document.getElementById('executionSummary');
            
            stepsDiv.innerHTML = `
                <div class="text-muted text-center">
                    <i class="bi bi-hourglass-split me-2"></i>
                    æ­£åœ¨åˆ†æä»»åŠ¡...
                </div>
            `;
            summaryDiv.style.display = 'none';
            console.log('ğŸ”„ é‡ç½®ä»»åŠ¡æ­¥éª¤æ˜¾ç¤º');
        }
        
        // æµç¨‹èŠ‚ç‚¹ç®¡ç†
        let processNodes = {};
        let currentStepCounts = {
            completed: 0,
            running: 0,
            pending: 0,
            warning: 0,
            failed: 0
        };
        
        // æ¸…ç©ºå¹¶æ·»åŠ ç¬¬ä¸€ä¸ªæ­¥éª¤
        function clearAndAddStep(category, description, status) {
            const stepsDiv = document.getElementById('taskSteps');
            stepsDiv.innerHTML = ''; // æ¸…ç©ºç°æœ‰å†…å®¹
            processNodes = {}; // é‡ç½®èŠ‚ç‚¹è®°å½•
            currentStepCounts = { completed: 0, running: 0, pending: 0, warning: 0, failed: 0 };
            
            addProcessNode(category, description, status);
            showExecutionSummary();
            console.log(`ğŸ”„ æ¸…ç©ºå¹¶æ·»åŠ ç¬¬ä¸€ä¸ªæ­¥éª¤: ${category} - ${description}`);
        }
        
        // æ·»åŠ æµç¨‹èŠ‚ç‚¹
        function addProcessNode(category, description, status, isSubStep = false) {
            const stepsDiv = document.getElementById('taskSteps');
            
            if (!processNodes[category]) {
                // åˆ›å»ºä¸»èŠ‚ç‚¹
                const nodeId = `node-${Object.keys(processNodes).length}`;
                processNodes[category] = {
                    id: nodeId,
                    element: null,
                    subSteps: [],
                    status: status,
                    startTime: new Date()
                };
                
                const nodeElement = document.createElement('div');
                nodeElement.className = `process-node ${status}`;
                nodeElement.id = nodeId;
                
                // è·å–åˆ†ç±»å›¾æ ‡
                const categoryIcon = getCategoryIcon(category);
                
                nodeElement.innerHTML = `
                    <div class="process-connector"></div>
                    <div class="process-header">
                        <div class="process-icon">${categoryIcon}</div>
                        <div class="process-title">${category}</div>
                        <div class="process-time">${new Date().toLocaleTimeString()}</div>
                    </div>
                    <div class="process-details">${description}</div>
                    <div class="sub-steps" id="sub-${nodeId}"></div>
                `;
                
                stepsDiv.appendChild(nodeElement);
                processNodes[category].element = nodeElement;
                
                updateStepCounts(status, 'add');
                console.log(`â• åˆ›å»ºæµç¨‹èŠ‚ç‚¹: ${category}`);
            } else if (isSubStep) {
                // æ·»åŠ å­æ­¥éª¤
                addSubStep(category, description, status);
            } else {
                // æ›´æ–°ä¸»èŠ‚ç‚¹
                updateProcessNode(category, description, status);
            }
            
            updateProgressBar();
            scrollToLatestStep();
        }
        
        // æ·»åŠ å­æ­¥éª¤
        function addSubStep(category, description, status) {
            const node = processNodes[category];
            if (!node) return;
            
            const subStepsContainer = document.getElementById(`sub-${node.id}`);
            const subStepElement = document.createElement('div');
            subStepElement.className = `sub-step ${status}`;
            
            const stepIcon = getStatusIcon(status);
            
            subStepElement.innerHTML = `
                <div class="sub-step-content">
                    <span class="sub-step-icon">${stepIcon}</span>
                    <span class="sub-step-text">${description}</span>
                    <span class="sub-step-time">${new Date().toLocaleTimeString()}</span>
                </div>
            `;
            
            subStepsContainer.appendChild(subStepElement);
            node.subSteps.push({ element: subStepElement, status: status });
            
            console.log(`ğŸ“ æ·»åŠ å­æ­¥éª¤: [${category}] ${description} (${status})`);
            
            // æ»šåŠ¨åˆ°æœ€æ–°å­æ­¥éª¤
            setTimeout(() => {
                subStepElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 50);
        }
        
        // æ›´æ–°æµç¨‹èŠ‚ç‚¹
        function updateProcessNode(category, description, newStatus) {
            const node = processNodes[category];
            if (!node) {
                addProcessNode(category, description, newStatus);
                return;
            }
            
            // æ›´æ–°è®¡æ•°
            updateStepCounts(node.status, 'remove');
            updateStepCounts(newStatus, 'add');
            
            // æ›´æ–°èŠ‚ç‚¹çŠ¶æ€
            node.status = newStatus;
            node.element.className = `process-node ${newStatus}`;
            
            // æ›´æ–°æè¿°
            const detailsElement = node.element.querySelector('.process-details');
            detailsElement.textContent = description;
            
            // æ›´æ–°æ—¶é—´
            const timeElement = node.element.querySelector('.process-time');
            timeElement.textContent = new Date().toLocaleTimeString();
            
            // æ›´æ–°å›¾æ ‡
            const iconElement = node.element.querySelector('.process-icon');
            iconElement.innerHTML = getCategoryIcon(category);
            
            updateProgressBar();
            console.log(`ğŸ”„ æ›´æ–°æµç¨‹èŠ‚ç‚¹: [${category}] ${description} (${newStatus})`);
            
            // æ»šåŠ¨åˆ°æ›´æ–°çš„èŠ‚ç‚¹
            setTimeout(() => {
                node.element.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 50);
        }
        
        // è·å–åˆ†ç±»å›¾æ ‡
        function getCategoryIcon(category) {
            const icons = {
                'ä»»åŠ¡åˆ†æ': 'ğŸ”',
                'æ˜ç¡®åº¦æ£€æŸ¥': 'ğŸ“Š',
                'è®¡åˆ’ç”Ÿæˆ': 'âš™ï¸',
                'ä»»åŠ¡æ‰§è¡Œ': 'ğŸš€',
                'æ­¥éª¤æ‰§è¡Œ': 'ğŸ”„',
                'å·¥å…·è°ƒç”¨': 'ğŸ”§',
                'ç»“æœæ”¶é›†': 'ğŸ“¥',
                'æŠ¥å‘Šç”Ÿæˆ': 'ğŸ“‹',
                'æ–‡ä»¶ç®¡ç†': 'ğŸ“„',
                'clarification_needed': 'â“',
                'plan_validation': 'âœ…',
                'å…¶ä»–': 'ğŸ“¡'
            };
            return icons[category] || 'ğŸ“Œ';
        }
        
        // è·å–çŠ¶æ€å›¾æ ‡
        function getStatusIcon(status) {
            const icons = {
                'running': 'ğŸ”„',
                'completed': 'âœ…',
                'failed': 'âŒ',
                'warning': 'âš ï¸',
                'pending': 'â³'
            };
            return icons[status] || 'ğŸ“Œ';
        }
        
        // æ›´æ–°æ­¥éª¤è®¡æ•°
        function updateStepCounts(status, action) {
            if (action === 'add') {
                currentStepCounts[status] = (currentStepCounts[status] || 0) + 1;
            } else if (action === 'remove') {
                currentStepCounts[status] = Math.max(0, (currentStepCounts[status] || 0) - 1);
            }
        }
        
        // æ˜¾ç¤ºæ‰§è¡ŒçŠ¶æ€æ€»è§ˆ
        function showExecutionSummary() {
            const summaryDiv = document.getElementById('executionSummary');
            summaryDiv.style.display = 'block';
        }
        
        // æ›´æ–°è¿›åº¦æ¡
        function updateProgressBar() {
            const progressBar = document.getElementById('progressBar');
            const progressStats = document.getElementById('progressStats');
            
            const total = Object.values(currentStepCounts).reduce((sum, count) => sum + count, 0);
            if (total === 0) return;
            
            const completedPercent = (currentStepCounts.completed / total) * 100;
            const runningPercent = (currentStepCounts.running / total) * 100;
            const pendingPercent = (currentStepCounts.pending / total) * 100;
            
            progressBar.innerHTML = `
                <div class="progress-segment completed" style="width: ${completedPercent}%"></div>
                <div class="progress-segment running" style="width: ${runningPercent}%"></div>
                <div class="progress-segment pending" style="width: ${pendingPercent}%"></div>
            `;
            
            progressStats.innerHTML = `
                <span>å·²å®Œæˆ: ${currentStepCounts.completed}</span>
                <span>è¿›è¡Œä¸­: ${currentStepCounts.running}</span>
                <span>æ€»è®¡: ${total}</span>
            `;
        }
        
        // æ›´æ–°æ—§å‡½æ•°ä»¥å…¼å®¹æ–°ç³»ç»Ÿ
        function addStepToCategory(category, description, status) {
            addProcessNode(category, description, status, true);
        }
        
        function updateStepInCategory(category, newDescription, newStatus) {
            updateProcessNode(category, newDescription, newStatus);
        }
        
        // æ»šåŠ¨åˆ°æœ€æ–°æ­¥éª¤
        function scrollToLatestStep() {
            const stepsDiv = document.getElementById('taskSteps');
            if (stepsDiv) {
                stepsDiv.scrollTop = stepsDiv.scrollHeight;
            }
        }
        
        // å¤„ç†ä»»åŠ¡æ–‡ä»¶
        function handleTaskFiles(data) {
            console.log('å¤„ç†ä»»åŠ¡æ–‡ä»¶ï¼Œæ•°æ®:', data);
            
            let files = [];
            let taskId = data.task_id || currentTaskId;
            
            // ä¼˜å…ˆä½¿ç”¨files_summary
            if (data.files_summary && data.files_summary.files) {
                console.log('ä½¿ç”¨files_summaryæ•°æ®');
                files = data.files_summary.files;
                addLogMessage(`> ç”Ÿæˆ ${data.files_summary.file_count || files.length} ä¸ªæ–‡ä»¶`);
            } else if (data.files_generated && data.files_generated.length > 0) {
                console.log('ä½¿ç”¨files_generatedæ•°æ®');
                // è½¬æ¢æ—§æ ¼å¼ä¸ºæ–°æ ¼å¼
                files = data.files_generated.map(filePath => ({
                    file_name: filePath.split('/').pop(),
                    file_path: filePath,
                    file_type: 'unknown',
                    file_size: 0,
                    task_id: taskId
                }));
                addLogMessage(`> ç”Ÿæˆ ${files.length} ä¸ªæ–‡ä»¶`);
            }
            
            if (files.length > 0) {
                console.log('æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨:', files);
                displayFiles(files, taskId);
            } else {
                console.log('æ²¡æœ‰æ–‡ä»¶å¯æ˜¾ç¤º');
                updateGeneratedFiles([], null);
            }
        }
        
        // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
        function displayFiles(files, taskId) {
            console.log('displayFilesè°ƒç”¨:', { files, taskId });
            
            const filesDiv = document.getElementById('generatedFiles');
            
            if (!files || files.length === 0) {
                filesDiv.innerHTML = '<div class="text-muted text-center">æš‚æ— ç”Ÿæˆæ–‡ä»¶</div>';
                return;
            }
            
            let filesHtml = '';
            
            files.forEach((file, index) => {
                const fileName = file.file_name || file.name || `æ–‡ä»¶${index + 1}`;
                const filePath = file.file_path || file.path || '';
                const fileSize = file.file_size || file.size || 0;
                const fileType = (file.file_type || file.type || 'unknown').toLowerCase();
                
                // ä¸ºæ–‡ä»¶æ·»åŠ task_idä¿¡æ¯
                const fileTaskId = file.task_id || taskId;
                
                // æ–‡ä»¶å›¾æ ‡
                let iconClass = 'bi-file-earmark';
                let iconColor = '#007bff';
                
                if (['py', 'js', 'html', 'css', 'json'].includes(fileType)) {
                    iconClass = 'bi-file-earmark-code';
                    iconColor = '#6f42c1';
                } else if (['txt', 'md'].includes(fileType)) {
                    iconClass = 'bi-file-earmark-text';
                    iconColor = '#17a2b8';
                } else if (['png', 'jpg', 'jpeg', 'gif'].includes(fileType)) {
                    iconClass = 'bi-file-earmark-image';
                    iconColor = '#fd7e14';
                } else if (['pdf'].includes(fileType)) {
                    iconClass = 'bi-file-earmark-pdf';
                    iconColor = '#dc3545';
                }
                
                // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
                const fileSizeText = formatFileSize(fileSize);
                
                // å†³å®šä½¿ç”¨å“ªç§ä¸‹è½½æ–¹å¼
                let downloadAction = '';
                if (fileTaskId && fileName) {
                    // ä¼˜å…ˆä½¿ç”¨task_id + filenameçš„æ–¹å¼
                    downloadAction = `downloadFileByTask('${fileTaskId}', '${fileName}')`;
                } else if (filePath && filePath.trim() !== '') {
                    // å¤‡ç”¨ï¼šä½¿ç”¨æ–‡ä»¶è·¯å¾„
                    downloadAction = `downloadFile('${filePath}')`;
                } else {
                    // æ— æ³•ä¸‹è½½
                    downloadAction = `alert('æ–‡ä»¶æ— æ³•ä¸‹è½½ï¼šç¼ºå°‘å¿…è¦ä¿¡æ¯')`;
                }
                
                let previewAction = '';
                if (['txt', 'md', 'py', 'js', 'html', 'css', 'json'].includes(fileType)) {
                    if (fileTaskId && fileName) {
                        previewAction = `previewFileByTask('${fileTaskId}', '${fileName}')`;
                    } else if (filePath && filePath.trim() !== '') {
                        previewAction = `previewFile('${filePath}', '${fileName}')`;
                    }
                }
                
                filesHtml += `
                    <div class="file-item d-flex align-items-center">
                        <div class="file-icon" style="background-color: ${iconColor}">
                            <i class="bi ${iconClass}"></i>
                        </div>
                        <div class="file-info">
                            <div class="file-name">${fileName}</div>
                            <div class="file-meta">
                                ${fileType.toUpperCase()} â€¢ ${fileSizeText}
                            </div>
                        </div>
                        <div class="file-actions">
                            <button class="btn btn-sm btn-outline-primary" 
                                    onclick="${downloadAction}" 
                                    title="ä¸‹è½½æ–‡ä»¶">
                                <i class="bi bi-download"></i>
                            </button>
                            ${previewAction ? 
                              `<button class="btn btn-sm btn-outline-secondary ms-1" 
                                       onclick="${previewAction}" 
                                       title="é¢„è§ˆæ–‡ä»¶">
                                   <i class="bi bi-eye"></i>
                               </button>` : ''
                            }
                        </div>
                    </div>
                `;
            });
            
            // æ·»åŠ ä¸‹è½½åŒ…æŒ‰é’®
            if (taskId && files.length > 1) {
                filesHtml += `
                    <button class="download-package" onclick="downloadTaskPackage('${taskId}')">
                        <i class="bi bi-archive me-2"></i>
                        ä¸‹è½½æ–‡ä»¶åŒ… (${files.length} ä¸ªæ–‡ä»¶)
                    </button>
                `;
            }
            
            filesDiv.innerHTML = filesHtml;
            console.log('æ–‡ä»¶åˆ—è¡¨HTMLå·²æ›´æ–°');
        }
        
        // æ›´æ–°ç”Ÿæˆæ–‡ä»¶ï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰
        function updateGeneratedFiles(files, taskId) {
            displayFiles(files, taskId);
        }
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // èŠå¤©è¡¨å•æäº¤
            document.getElementById('chatForm').addEventListener('submit', function(e) {
                e.preventDefault();
                submitMessage();
            });
            
            // å¿«é€Ÿä»»åŠ¡æŒ‰é’®
            document.querySelectorAll('.quick-task').forEach(button => {
                button.addEventListener('click', function() {
                    const task = this.getAttribute('data-task');
                    document.getElementById('messageInput').value = task;
                    submitMessage();
                });
            });
            
            // å›è½¦é”®å‘é€æ¶ˆæ¯
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    submitMessage();
                }
            });
        }
        
        // æäº¤æ¶ˆæ¯
        function submitMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || !isConnected) {
                console.log('æ¶ˆæ¯ä¸ºç©ºæˆ–æœªè¿æ¥ï¼Œè·³è¿‡å‘é€');
                return;
            }
            
            console.log('å‘é€æ¶ˆæ¯:', message);
            addLogMessage(`> ğŸ’¬ ç”¨æˆ·: ${message.length > 20 ? message.substring(0, 20) + '...' : message}`);
            
            // æ¸…ç©ºä¹‹å‰çš„ä»»åŠ¡æ­¥éª¤æ˜¾ç¤º
            const stepsDiv = document.getElementById('taskSteps');
            stepsDiv.innerHTML = '<div class="text-muted text-center">æ­£åœ¨åˆ†æä»»åŠ¡...</div>';
            
            // é€šè¿‡WebSocketå‘é€æ¶ˆæ¯
            websocket.send(JSON.stringify({
                type: 'task_submit',
                content: message
            }));
            
            input.value = '';
            document.getElementById('sendBtn').disabled = true;
            
            // 3ç§’åæ¢å¤å‘é€æŒ‰é’®
            setTimeout(() => {
                document.getElementById('sendBtn').disabled = false;
            }, 3000);
        }
        
        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
        function addMessage(message) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.sender}`;
            
            let iconClass = '';
            let senderName = '';
            if (message.sender === 'user') {
                iconClass = 'bi bi-person-circle';
                senderName = 'æ‚¨';
            } else if (message.sender === 'assistant') {
                iconClass = 'bi bi-robot';
                senderName = 'AIåŠ©æ‰‹';
            }
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <i class="${iconClass}"></i>
                    <span>${senderName}</span>
                    <span class="ms-auto">${new Date(message.timestamp).toLocaleTimeString()}</span>
                </div>
                <div class="message-bubble">
                    <div class="message-content"></div>
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            
            // å¦‚æœæ˜¯åŠ©æ‰‹æ¶ˆæ¯ï¼Œä½¿ç”¨æµå¼è¾“å‡º
            if (message.sender === 'assistant') {
                typewriterEffect(messageDiv.querySelector('.message-content'), message.content);
            } else {
                // ç”¨æˆ·æ¶ˆæ¯ç›´æ¥æ˜¾ç¤º
                messageDiv.querySelector('.message-content').innerHTML = formatMessageContent(message.content);
            }
            
            scrollToBottom();
        }
        
        // æ‰“å­—æœºæ•ˆæœå‡½æ•°ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
        function typewriterEffect(element, text, baseSpeed = 25) {
            const formattedText = formatMessageContent(text);
            
            // åˆ›å»ºä¸€ä¸ªä¸´æ—¶å…ƒç´ æ¥è§£æHTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = formattedText;
            
            // æå–çº¯æ–‡æœ¬å†…å®¹ç”¨äºæ‰“å­—æœºæ•ˆæœ
            const plainText = tempDiv.textContent || tempDiv.innerText || '';
            
            // æ ¹æ®æ–‡æœ¬é•¿åº¦è°ƒæ•´åŸºç¡€é€Ÿåº¦
            let speed = baseSpeed;
            if (plainText.length > 500) {
                speed = Math.max(15, baseSpeed - 10); // é•¿æ–‡æœ¬æ›´å¿«
            } else if (plainText.length > 200) {
                speed = Math.max(20, baseSpeed - 5); // ä¸­ç­‰é•¿åº¦ç¨å¿«
            }
            
            element.innerHTML = '';
            let index = 0;
            let isPaused = false;
            
            // æ˜¾ç¤ºå…‰æ ‡
            const cursor = document.createElement('span');
            cursor.className = 'typing-cursor';
            cursor.textContent = 'â–Š';
            cursor.style.animation = 'blink 1s infinite';
            element.appendChild(cursor);
            
            // æ·»åŠ è·³è¿‡æŒ‰é’®ï¼ˆé•¿æ–‡æœ¬æ—¶ï¼‰
            let skipButton = null;
            if (plainText.length > 100) {
                skipButton = document.createElement('button');
                skipButton.className = 'btn btn-sm btn-outline-secondary ms-2 skip-typing';
                skipButton.innerHTML = '<i class="bi bi-fast-forward"></i> è·³è¿‡';
                skipButton.style.position = 'relative';
                skipButton.style.fontSize = '0.7rem';
                skipButton.onclick = () => {
                    skipToEnd();
                };
                element.parentNode.appendChild(skipButton);
            }
            
            function skipToEnd() {
                isPaused = true;
                if (cursor.parentNode) {
                    cursor.remove();
                }
                if (skipButton && skipButton.parentNode) {
                    skipButton.remove();
                }
                element.innerHTML = formattedText;
                scrollToBottom();
            }
            
            function typeChar() {
                if (isPaused) return;
                
                if (index < plainText.length) {
                    // ç§»é™¤å…‰æ ‡
                    if (cursor.parentNode) {
                        cursor.remove();
                    }
                    
                    // æ·»åŠ å­—ç¬¦
                    const currentText = plainText.slice(0, index + 1);
                    element.textContent = currentText;
                    
                    // é‡æ–°æ·»åŠ å…‰æ ‡
                    element.appendChild(cursor);
                    
                    index++;
                    
                    // æ™ºèƒ½é€Ÿåº¦æ§åˆ¶
                    let charSpeed = speed;
                    const currentChar = plainText[index - 1];
                    
                    // æ ‡ç‚¹ç¬¦å·åçš„åœé¡¿
                    if (currentChar === 'ã€‚' || currentChar === 'ï¼' || currentChar === 'ï¼Ÿ' || currentChar === '.' || currentChar === '!' || currentChar === '?') {
                        charSpeed = speed * 4; // å¥å·ååœé¡¿
                    } else if (currentChar === 'ï¼Œ' || currentChar === 'ï¼›' || currentChar === ',' || currentChar === ';' || currentChar === 'ï¼š' || currentChar === ':') {
                        charSpeed = speed * 2.5; // é€—å·ã€åˆ†å·ã€å†’å·åç¨åœé¡¿
                    } else if (currentChar === '\n') {
                        charSpeed = speed * 3; // æ¢è¡Œååœé¡¿
                    } else if (currentChar === ' ') {
                        charSpeed = speed * 0.3; // ç©ºæ ¼å¿«é€Ÿ
                    } else if (/[a-zA-Z0-9]/.test(currentChar)) {
                        charSpeed = speed * 0.8; // è‹±æ–‡æ•°å­—ç¨å¿«
                    }
                    
                    // éšæœºå˜åŒ–ï¼Œæ›´è‡ªç„¶
                    charSpeed = charSpeed * (0.8 + Math.random() * 0.4);
                    
                    setTimeout(typeChar, charSpeed);
                    
                    // æ¯10ä¸ªå­—ç¬¦æ»šåŠ¨ä¸€æ¬¡ï¼Œé¿å…è¿‡äºé¢‘ç¹
                    if (index % 10 === 0) {
                        scrollToBottom();
                    }
                } else {
                    // æ‰“å­—å®Œæˆ
                    isPaused = true;
                    if (cursor.parentNode) {
                        cursor.remove();
                    }
                    if (skipButton && skipButton.parentNode) {
                        skipButton.remove();
                    }
                    element.innerHTML = formattedText;
                    scrollToBottom();
                    
                    // å®ŒæˆåŠ¨ç”»æ•ˆæœ
                    element.style.animation = 'fadeIn 0.3s ease-in';
                }
            }
            
            // å¼€å§‹æ‰“å­—æ•ˆæœ
            setTimeout(typeChar, 200);
        }
        
        // æ·»åŠ å®ŒæˆåŠ¨ç”»CSS
        const additionalStyle = document.createElement('style');
        additionalStyle.textContent = `
            @keyframes fadeIn {
                from { opacity: 0.8; }
                to { opacity: 1; }
            }
            .skip-typing {
                animation: slideIn 0.3s ease-out;
            }
            @keyframes slideIn {
                from { 
                    opacity: 0;
                    transform: translateX(10px);
                }
                to { 
                    opacity: 1;
                    transform: translateX(0);
                }
            }
        `;
        document.head.appendChild(additionalStyle);
        
        // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
        function addSystemMessage(message) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system';
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    <i class="bi bi-info-circle me-1"></i>
                    <span class="system-content"></span>
                </div>
            `;
            messagesContainer.appendChild(messageDiv);
            
            // ç³»ç»Ÿæ¶ˆæ¯ä¹Ÿä½¿ç”¨è½»å¾®çš„æ‰“å­—æ•ˆæœ
            const contentElement = messageDiv.querySelector('.system-content');
            typewriterEffect(contentElement, message, 15); // æ›´å¿«çš„é€Ÿåº¦
            
            scrollToBottom();
        }
        
        // æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹
        function formatMessageContent(content) {
            // æ£€æŸ¥æ˜¯å¦åŒ…å«å›¾è¡¨HTMLå†…å®¹
            if (typeof content === 'string' && (content.includes('plotly') || content.includes('<!DOCTYPE html>'))) {
                // å¦‚æœæ˜¯å®Œæ•´çš„HTMLæ–‡æ¡£ï¼Œåˆ›å»ºiframeæ˜¾ç¤º
                if (content.trim().startsWith('<!DOCTYPE html>') || content.trim().startsWith('<html')) {
                    const iframe = document.createElement('iframe');
                    iframe.style.width = '100%';
                    iframe.style.height = '500px';
                    iframe.style.border = '1px solid #ddd';
                    iframe.style.borderRadius = '8px';
                    iframe.srcdoc = content;
                    
                    const container = document.createElement('div');
                    container.className = 'chart-container mb-3';
                    container.appendChild(iframe);
                    
                    const caption = document.createElement('div');
                    caption.className = 'text-muted small text-center mt-2';
                    caption.innerHTML = '<i class="bi bi-bar-chart"></i> äº¤äº’å¼å›¾è¡¨';
                    container.appendChild(caption);
                    
                    return container.outerHTML;
                }
            }
            
            // å¤„ç†æ¢è¡Œç¬¦
            content = content.replace(/\n/g, '<br>');
            
            // å¤„ç†ä»£ç å—
            content = content.replace(/```(.*?)```/gs, '<pre class="bg-light p-2 rounded"><code>$1</code></pre>');
            
            // å¤„ç†è¡Œå†…ä»£ç 
            content = content.replace(/`([^`]+)`/g, '<code class="bg-light px-1 rounded">$1</code>');
            
            return content;
        }
        
        // æ˜¾ç¤º/éšè—è¾“å…¥æŒ‡ç¤ºå™¨ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
        function showTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            indicator.style.display = 'block';
            
            // æ·»åŠ æ¸ç°æ•ˆæœ
            indicator.style.opacity = '0';
            indicator.style.transform = 'translateY(10px)';
            
            setTimeout(() => {
                indicator.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                indicator.style.opacity = '1';
                indicator.style.transform = 'translateY(0)';
            }, 50);
            
            scrollToBottom();
        }
        
        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            
            indicator.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            indicator.style.opacity = '0';
            indicator.style.transform = 'translateY(-10px)';
            
            setTimeout(() => {
                indicator.style.display = 'none';
                indicator.style.transition = '';
                indicator.style.transform = '';
            }, 300);
        }
        
        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(status, text) {
            const indicator = document.getElementById('connectionStatus');
            const textElement = document.getElementById('connectionText');
            
            indicator.className = `status-indicator status-${status}`;
            textElement.textContent = text;
        }
        
        // æ›´æ–°ä»»åŠ¡çŠ¶æ€
        function updateTaskStatus(message, type) {
            const statusDiv = document.getElementById('taskStatus');
            const colorClass = {
                'info': 'text-info',
                'warning': 'text-warning', 
                'success': 'text-success',
                'danger': 'text-danger'
            }[type] || 'text-muted';
            
            statusDiv.innerHTML = `
                <div class="${colorClass}">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'danger' ? 'x-circle' : 'hourglass'}"></i>
                    ${message}
                </div>
            `;
        }
        
        // æ›´æ–°ä»»åŠ¡æ­¥éª¤
        function updateTaskStage(stage) {
            const stepsDiv = document.getElementById('taskSteps');
            
            const stages = {
                'analyzing': 'ä»»åŠ¡åˆ†æ',
                'planning': 'åˆ¶å®šè®¡åˆ’', 
                'executing': 'æ‰§è¡Œä»»åŠ¡',
                'collecting': 'æ”¶é›†ç»“æœ'
            };
            
            const stageNames = Object.values(stages);
            const currentIndex = Object.keys(stages).indexOf(stage);
            
            let stepsHtml = '';
            stageNames.forEach((name, index) => {
                let className = 'step-item';
                if (index < currentIndex) {
                    className += ' completed';
                } else if (index === currentIndex) {
                    className += ' running';
                }
                
                stepsHtml += `
                    <div class="${className}">
                        <small>${name}</small>
                    </div>
                `;
            });
            
            stepsDiv.innerHTML = stepsHtml;
        }
        
        // æ·»åŠ æ—¥å¿—æ¶ˆæ¯ï¼ˆå·²å¼ƒç”¨ï¼Œç°åœ¨ä½¿ç”¨ç³»ç»Ÿæ¶ˆæ¯ï¼‰
        function addLogMessage(message) {
            // ç°åœ¨æ—¥å¿—ç›´æ¥æ˜¾ç¤ºåœ¨å¯¹è¯ä¸­ï¼Œè¿™ä¸ªå‡½æ•°ä¿ç•™ä»¥å…¼å®¹ç°æœ‰ä»£ç 
            console.log('æ—¥å¿—:', message);
        }
        
        // å¤„ç†æµå¼æ—¥å¿—æ¶ˆæ¯
        function handleLogStream(data) {
            // è¿‡æ»¤ä¸å¿…è¦çš„æ—¥å¿—çº§åˆ«
            if (data.level === 'DEBUG' && !window.debugMode) {
                return; // åœ¨éè°ƒè¯•æ¨¡å¼ä¸‹ä¸æ˜¾ç¤ºDEBUGæ—¥å¿—
            }
            
            // æ·»åŠ åˆ°èŠå¤©å¯¹è¯æ¡†ä¸­
            addLogMessageToChat(data);
            
            // åŒæ—¶åœ¨æ§åˆ¶å°è¾“å‡º
            console.log('ğŸ“‹ æ—¥å¿—:', data.message);
        }
        
        // åˆ‡æ¢è°ƒè¯•æ¨¡å¼
        function toggleDebugMode() {
            const debugSwitch = document.getElementById('debugModeSwitch');
            window.debugMode = debugSwitch.checked;
            
            if (window.debugMode) {
                addSystemMessage('ğŸ” è¯¦ç»†æ—¥å¿—å·²å¼€å¯ - ç³»ç»Ÿè¿è¡Œæ—¥å¿—å°†æ˜¾ç¤ºåœ¨å¯¹è¯ä¸­');
            } else {
                addSystemMessage('ğŸ” è¯¦ç»†æ—¥å¿—å·²å…³é—­ - ä»…æ˜¾ç¤ºé‡è¦ä¿¡æ¯');
            }
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('debugMode', window.debugMode);
        }
        
        // æ·»åŠ æ—¥å¿—æ¶ˆæ¯åˆ°èŠå¤©å¯¹è¯æ¡†
        function addLogMessageToChat(logData) {
            const messagesContainer = document.getElementById('chatMessages');
            const timestamp = new Date(logData.timestamp).toLocaleTimeString();
            
            // æ ¹æ®æ—¥å¿—çº§åˆ«é€‰æ‹©å›¾æ ‡å’Œé¢œè‰²
            const levelConfig = {
                'DEBUG': { icon: 'ğŸ”', color: '#6c757d', bgColor: '#f8f9fa' },
                'INFO': { icon: 'â„¹ï¸', color: '#17a2b8', bgColor: '#e8f4f8' },
                'WARNING': { icon: 'âš ï¸', color: '#e67e22', bgColor: '#fff3cd' },
                'ERROR': { icon: 'âŒ', color: '#dc3545', bgColor: '#f8d7da' },
                'CRITICAL': { icon: 'ğŸš¨', color: '#dc3545', bgColor: '#f5c6cb' }
            };
            
            const config = levelConfig[logData.level] || levelConfig['INFO'];
            
            // ç®€åŒ–loggeråç§°æ˜¾ç¤º
            let shortLogger = logData.logger
                .replace('core.', '')
                .replace('tools.', '')
                .replace('communication.', '')
                .replace('interfaces.web.frontend.', '');
                
            // åˆ›å»ºæ—¥å¿—æ¶ˆæ¯å…ƒç´ 
            const messageDiv = document.createElement('div');
            messageDiv.className = `message system log-message log-${logData.level.toLowerCase()}`;
            messageDiv.innerHTML = `
                <div class="message-bubble" style="background-color: ${config.bgColor}; border-left: 3px solid ${config.color}; max-width: 90%;">
                    <div class="log-header" style="display: flex; align-items: center; margin-bottom: 4px; font-size: 0.75rem; color: ${config.color};">
                        <span style="margin-right: 6px;">${config.icon}</span>
                        <span style="font-weight: 500; margin-right: 8px;">${logData.level}</span>
                        <span style="color: #6c757d; margin-right: 8px;">[${shortLogger}]</span>
                        <span style="color: #6c757d; margin-left: auto;">${timestamp}</span>
                    </div>
                    <div class="log-content" style="font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 0.8rem; color: #333; line-height: 1.3; word-break: break-word;">
                        ${escapeHtml(logData.message)}
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            scrollToBottom();
            
            // é™åˆ¶æ¶ˆæ¯æ•°é‡ï¼Œä¿æŒæ€§èƒ½
            const allMessages = messagesContainer.querySelectorAll('.message');
            if (allMessages.length > 1000) {
                // ç§»é™¤æœ€æ—§çš„æ—¥å¿—æ¶ˆæ¯ï¼ˆä¿ç•™ç”¨æˆ·å’ŒAIæ¶ˆæ¯ï¼‰
                const logMessages = messagesContainer.querySelectorAll('.message.log-message');
                for (let i = 0; i < Math.min(100, logMessages.length); i++) {
                    logMessages[i].remove();
                }
            }
        }
        
        // HTMLè½¬ä¹‰å‡½æ•°
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }
        
        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
        
        // ä¸‹è½½æ–‡ä»¶ï¼ˆé€šè¿‡task_idå’Œæ–‡ä»¶åï¼‰
        function downloadFileByTask(taskId, fileName) {
            try {
                console.log('ä¸‹è½½æ–‡ä»¶ï¼ˆé€šè¿‡ä»»åŠ¡ï¼‰:', taskId, fileName);
                const downloadUrl = `/api/download_by_task/${taskId}/${encodeURIComponent(fileName)}`;
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                addLogMessage(`> ğŸ“ ä¸‹è½½: ${fileName}`);
                
            } catch (error) {
                console.error('ä¸‹è½½æ–‡ä»¶å¤±è´¥:', error);
                addLogMessage(`> âŒ ä¸‹è½½å¤±è´¥: ${fileName}`);
            }
        }
        
        // ä¸‹è½½æ–‡ä»¶ï¼ˆåŸæœ‰æ–¹æ³•ï¼Œä¿æŒå…¼å®¹æ€§ï¼‰
        function downloadFile(filePath) {
            try {
                console.log('ä¸‹è½½æ–‡ä»¶:', filePath);
                const downloadUrl = `/api/download/${encodeURIComponent(filePath)}`;
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = filePath.split('/').pop();
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                addLogMessage(`> ğŸ“ ä¸‹è½½: ${filePath.split('/').pop()}`);
                
            } catch (error) {
                console.error('ä¸‹è½½æ–‡ä»¶å¤±è´¥:', error);
                addLogMessage(`> âŒ ä¸‹è½½å¤±è´¥: ${filePath.split('/').pop()}`);
            }
        }
        
        // é¢„è§ˆæ–‡ä»¶ï¼ˆé€šè¿‡task_idå’Œæ–‡ä»¶åï¼‰
        function previewFileByTask(taskId, fileName) {
            try {
                console.log('é¢„è§ˆæ–‡ä»¶ï¼ˆé€šè¿‡ä»»åŠ¡ï¼‰:', taskId, fileName);
                addLogMessage(`> ğŸ‘ï¸ é¢„è§ˆ: ${fileName}`);
                fetch(`/api/download_by_task/${taskId}/${encodeURIComponent(fileName)}`)
                    .then(response => response.text())
                    .then(content => {
                        showFilePreviewModal(fileName, content, null, taskId);
                    })
                    .catch(error => {
                        console.error('é¢„è§ˆæ–‡ä»¶å¤±è´¥:', error);
                        addLogMessage(`> âŒ é¢„è§ˆå¤±è´¥: ${fileName}`);
                    });
                    
            } catch (error) {
                console.error('é¢„è§ˆæ–‡ä»¶å¤±è´¥:', error);
                addLogMessage(`> âŒ é¢„è§ˆå¤±è´¥: ${fileName}`);
            }
        }
        
        // é¢„è§ˆæ–‡ä»¶ï¼ˆåŸæœ‰æ–¹æ³•ï¼Œä¿æŒå…¼å®¹æ€§ï¼‰
        function previewFile(filePath, fileName) {
            try {
                console.log('é¢„è§ˆæ–‡ä»¶:', filePath);
                addLogMessage(`> ğŸ‘ï¸ é¢„è§ˆ: ${fileName}`);
                fetch(`/api/download/${encodeURIComponent(filePath)}`)
                    .then(response => response.text())
                    .then(content => {
                        showFilePreviewModal(fileName, content, filePath);
                    })
                    .catch(error => {
                        console.error('é¢„è§ˆæ–‡ä»¶å¤±è´¥:', error);
                        addLogMessage(`> âŒ é¢„è§ˆå¤±è´¥: ${fileName}`);
                    });
                    
            } catch (error) {
                console.error('é¢„è§ˆæ–‡ä»¶å¤±è´¥:', error);
                addLogMessage(`> âŒ é¢„è§ˆå¤±è´¥: ${fileName}`);
            }
        }
        
        // æ˜¾ç¤ºæ–‡ä»¶é¢„è§ˆæ¨¡æ€æ¡†
        function showFilePreviewModal(fileName, content, filePath, taskId) {
            // å†³å®šä¸‹è½½æ–¹å¼
            let downloadAction = '';
            if (taskId && fileName) {
                downloadAction = `downloadFileByTask('${taskId}', '${fileName}')`;
            } else if (filePath) {
                downloadAction = `downloadFile('${filePath}')`;
            } else {
                downloadAction = `alert('æ— æ³•ä¸‹è½½æ–‡ä»¶')`;
            }
            
            const modalHtml = `
                <div class="modal fade" id="filePreviewModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="bi bi-file-earmark-text me-2"></i>
                                    æ–‡ä»¶é¢„è§ˆ: ${fileName}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <pre class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto; font-size: 0.8rem; white-space: pre-wrap;">${content}</pre>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" onclick="${downloadAction}">
                                    <i class="bi bi-download me-1"></i>ä¸‹è½½æ–‡ä»¶
                                </button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // ç§»é™¤å·²å­˜åœ¨çš„æ¨¡æ€æ¡†
            const existingModal = document.getElementById('filePreviewModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // æ·»åŠ æ–°æ¨¡æ€æ¡†
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            const modal = new bootstrap.Modal(document.getElementById('filePreviewModal'));
            modal.show();
        }
        
        // ä¸‹è½½ä»»åŠ¡æ–‡ä»¶åŒ…
        function downloadTaskPackage(taskId) {
            try {
                console.log('ä¸‹è½½æ–‡ä»¶åŒ…ï¼ŒtaskId:', taskId);
                const downloadUrl = `/api/files/download_package/${taskId}?user_id=${userId}`;
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = `task_${taskId}_files.zip`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                addLogMessage(`> ğŸ“¦ ä¸‹è½½æ–‡ä»¶åŒ…: task_${taskId}`);
                
            } catch (error) {
                console.error('ä¸‹è½½æ–‡ä»¶åŒ…å¤±è´¥:', error);
                addLogMessage(`> âŒ ä¸‹è½½æ–‡ä»¶åŒ…å¤±è´¥: ${error.message}`);
            }
        }
        
        // åŠ è½½èŠå¤©å†å²
        function loadChatHistory(messages) {
            const messagesContainer = document.getElementById('chatMessages');
            
            // ä¿ç•™ç³»ç»Ÿæ¬¢è¿æ¶ˆæ¯
            const systemMsg = messagesContainer.querySelector('.message.system');
            messagesContainer.innerHTML = '';
            
            if (systemMsg) {
                messagesContainer.appendChild(systemMsg);
            }
            
            // æ·»åŠ å†å²æ¶ˆæ¯
            messages.forEach(msg => {
                addMessage(msg);
            });
            
            scrollToBottom();
        }
        
        // æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom() {
            const messagesContainer = document.getElementById('chatMessages');
            if (messagesContainer) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }
        
        // å®šæ—¶å‘é€å¿ƒè·³
        setInterval(() => {
            if (isConnected && websocket) {
                websocket.send(JSON.stringify({type: 'ping'}));
            }
        }, 30000);
        
        // é¡µé¢å¸è½½æ—¶å…³é—­WebSocket
        window.addEventListener('beforeunload', function() {
            if (websocket) {
                websocket.close();
            }
        });
    </script>
</body>
</html> 